<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>IFlowV4</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../highlight.css">
        <link rel="stylesheet" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../../book.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../../../index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">src</li><li class="chapter-item "><a href="../../../../src/abstract/index.html">❱ abstract</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/abstract/FlowCommon.sol/error.BadMinStackLength.html">BadMinStackLength</a></li><li class="chapter-item "><a href="../../../../src/abstract/FlowCommon.sol/abstract.FlowCommon.html">FlowCommon</a></li><li class="chapter-item "><a href="../../../../src/abstract/FlowCommon.sol/constants.FlowCommon.html">FlowCommon constants</a></li></ol></li><li class="chapter-item "><a href="../../../../src/concrete/index.html">❱ concrete</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/concrete/basic/index.html">❱ basic</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/concrete/basic/Flow.sol/contract.Flow.html">Flow</a></li><li class="chapter-item "><a href="../../../../src/concrete/basic/Flow.sol/constants.Flow.html">Flow constants</a></li></ol></li><li class="chapter-item "><a href="../../../../src/concrete/erc1155/index.html">❱ erc1155</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/concrete/erc1155/FlowERC1155.sol/contract.FlowERC1155.html">FlowERC1155</a></li><li class="chapter-item "><a href="../../../../src/concrete/erc1155/FlowERC1155.sol/constants.FlowERC1155.html">FlowERC1155 constants</a></li></ol></li><li class="chapter-item "><a href="../../../../src/concrete/erc20/index.html">❱ erc20</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/concrete/erc20/FlowERC20.sol/contract.FlowERC20.html">FlowERC20</a></li><li class="chapter-item "><a href="../../../../src/concrete/erc20/FlowERC20.sol/constants.FlowERC20.html">FlowERC20 constants</a></li></ol></li><li class="chapter-item "><a href="../../../../src/concrete/erc721/index.html">❱ erc721</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/concrete/erc721/FlowERC721.sol/contract.FlowERC721.html">FlowERC721</a></li><li class="chapter-item "><a href="../../../../src/concrete/erc721/FlowERC721.sol/constants.FlowERC721.html">FlowERC721 constants</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../../src/interface/index.html">❱ interface</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/interface/deprecated/index.html">❱ deprecated</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/index.html">❱ v1</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC1155V1.sol/struct.FlowERC1155Config.html">FlowERC1155Config</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC1155V1.sol/struct.ERC1155SupplyChange.html">ERC1155SupplyChange</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC1155V1.sol/struct.FlowERC1155IO.html">FlowERC1155IO</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC1155V1.sol/interface.IFlowERC1155V1.html">IFlowERC1155V1</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC20V1.sol/struct.ERC20SupplyChange.html">ERC20SupplyChange</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC20V1.sol/struct.FlowERC20IO.html">FlowERC20IO</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC20V1.sol/struct.FlowERC20Config.html">FlowERC20Config</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC20V1.sol/interface.IFlowERC20V1.html">IFlowERC20V1</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC721V1.sol/struct.FlowERC721Config.html">FlowERC721Config</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC721V1.sol/struct.ERC721SupplyChange.html">ERC721SupplyChange</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC721V1.sol/struct.FlowERC721IO.html">FlowERC721IO</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowERC721V1.sol/interface.IFlowERC721V1.html">IFlowERC721V1</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowV1.sol/struct.FlowConfig.html">FlowConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowV1.sol/struct.NativeTransfer.html">NativeTransfer</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowV1.sol/struct.ERC20Transfer.html">ERC20Transfer</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowV1.sol/struct.ERC721Transfer.html">ERC721Transfer</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowV1.sol/struct.ERC1155Transfer.html">ERC1155Transfer</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowV1.sol/struct.FlowTransfer.html">FlowTransfer</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v1/IFlowV1.sol/interface.IFlowV1.html">IFlowV1</a></li></ol></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/index.html">❱ v2</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC1155V2.sol/struct.FlowERC1155Config.html">FlowERC1155Config</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC1155V2.sol/struct.ERC1155SupplyChange.html">ERC1155SupplyChange</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC1155V2.sol/struct.FlowERC1155IO.html">FlowERC1155IO</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC1155V2.sol/interface.IFlowERC1155V2.html">IFlowERC1155V2</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC20V2.sol/struct.ERC20SupplyChange.html">ERC20SupplyChange</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC20V2.sol/struct.FlowERC20IO.html">FlowERC20IO</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC20V2.sol/struct.FlowERC20Config.html">FlowERC20Config</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC20V2.sol/interface.IFlowERC20V2.html">IFlowERC20V2</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC721V2.sol/struct.FlowERC721Config.html">FlowERC721Config</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC721V2.sol/struct.ERC721SupplyChange.html">ERC721SupplyChange</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC721V2.sol/struct.FlowERC721IO.html">FlowERC721IO</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowERC721V2.sol/interface.IFlowERC721V2.html">IFlowERC721V2</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowV2.sol/struct.FlowConfig.html">FlowConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowV2.sol/struct.NativeTransfer.html">NativeTransfer</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowV2.sol/struct.ERC20Transfer.html">ERC20Transfer</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowV2.sol/struct.ERC721Transfer.html">ERC721Transfer</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowV2.sol/struct.ERC1155Transfer.html">ERC1155Transfer</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowV2.sol/struct.FlowTransfer.html">FlowTransfer</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/v2/IFlowV2.sol/interface.IFlowV2.html">IFlowV2</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../../src/interface/unstable/index.html">❱ unstable</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/interface/unstable/IFlowERC1155V4.sol/struct.FlowERC1155ConfigV2.html">FlowERC1155ConfigV2</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IFlowERC1155V4.sol/interface.IFlowERC1155V4.html">IFlowERC1155V4</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IFlowERC20V4.sol/struct.FlowERC20ConfigV2.html">FlowERC20ConfigV2</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IFlowERC20V4.sol/interface.IFlowERC20V4.html">IFlowERC20V4</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IFlowERC721V4.sol/error.BurnerNotOwner.html">BurnerNotOwner</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IFlowERC721V4.sol/struct.FlowERC721ConfigV2.html">FlowERC721ConfigV2</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IFlowERC721V4.sol/interface.IFlowERC721V4.html">IFlowERC721V4</a></li><li class="chapter-item expanded "><a href="../../../../src/interface/unstable/IFlowV4.sol/interface.IFlowV4.html" class="active">IFlowV4</a></li></ol></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC1155V3.sol/struct.FlowERC1155Config.html">FlowERC1155Config</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC1155V3.sol/struct.ERC1155SupplyChange.html">ERC1155SupplyChange</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC1155V3.sol/struct.FlowERC1155IOV1.html">FlowERC1155IOV1</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC1155V3.sol/interface.IFlowERC1155V3.html">IFlowERC1155V3</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC1155V3.sol/constants.IFlowERC1155V3.html">IFlowERC1155V3 constants</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC20V3.sol/struct.ERC20SupplyChange.html">ERC20SupplyChange</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC20V3.sol/struct.FlowERC20IOV1.html">FlowERC20IOV1</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC20V3.sol/struct.FlowERC20Config.html">FlowERC20Config</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC20V3.sol/interface.IFlowERC20V3.html">IFlowERC20V3</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC20V3.sol/constants.IFlowERC20V3.html">IFlowERC20V3 constants</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC721V3.sol/struct.FlowERC721Config.html">FlowERC721Config</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC721V3.sol/struct.ERC721SupplyChange.html">ERC721SupplyChange</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC721V3.sol/struct.FlowERC721IOV1.html">FlowERC721IOV1</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC721V3.sol/interface.IFlowERC721V3.html">IFlowERC721V3</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowERC721V3.sol/constants.IFlowERC721V3.html">IFlowERC721V3 constants</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/error.UnregisteredFlow.html">UnregisteredFlow</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/error.UnsupportedNativeFlow.html">UnsupportedNativeFlow</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/error.UnsupportedERC20Flow.html">UnsupportedERC20Flow</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/error.UnsupportedERC721Flow.html">UnsupportedERC721Flow</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/error.UnsupportedERC1155Flow.html">UnsupportedERC1155Flow</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/struct.FlowConfig.html">FlowConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/struct.ERC20Transfer.html">ERC20Transfer</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/struct.ERC721Transfer.html">ERC721Transfer</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/struct.ERC1155Transfer.html">ERC1155Transfer</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/struct.FlowTransferV1.html">FlowTransferV1</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/interface.IFlowV3.html">IFlowV3</a></li><li class="chapter-item "><a href="../../../../src/interface/IFlowV3.sol/constants.IFlowV3.html">IFlowV3 constants</a></li></ol></li><li class="chapter-item "><a href="../../../../src/lib/index.html">❱ lib</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/lib/LibFlow.sol/library.LibFlow.html">LibFlow</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rainprotocol/rain.flow" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="iflowv4"><a class="header" href="#iflowv4">IFlowV4</a></h1>
<p><a href="https://github.com/rainprotocol/rain.flow/blob/b93f3e37ffc47aaff2e18f027f6f1a8544f6129f/src/interface/unstable/IFlowV4.sol">Git Source</a></p>
<p>Interface for a flow contract that does NOT require native minting
or burning of itself as a token. This is the base case that all other flow
interfaces model themselves after, with the addition of token minting and
burning.
Current functionality only allows for moving third party tokens between
accounts. Token standards ERC20, ERC721, and ERC1155 are supported.
The basic lifecycle of a flow is:</p>
<ul>
<li><code>Flow</code> is deployed as a reference implementation to be cloned, with its
initializers disabled on construction.</li>
<li><code>Flow</code> is cloned and initialized with an abi encoded list of evaluable
configs that define every possible movement of tokens that can occur due
to the clone. The EOA that deployed the clone DOES NOT have any special
privileges over the clone, although they could grant themselves privileges
by flowing tokens to themselves or similar within the evaluables. Ideally
the EOA doesn't introduce &quot;admin&quot; features as it would be a security risk
to themselves and others. In the case that they do, all priviledges will
be visible in the rainlang code of the evaluable, there's no hidden
functionality that can be introduced to the clone bytecode.</li>
<li>Anyone can call <code>flow</code> on the clone, passing in one of the evaluables set
during initialization. If the evaluable passed by the caller does not
match an initialized evaluable, the flow MUST revert with
<code>UnregisteredFlow</code>. The entirety of the resulting stack from the evaluation
defines all the token movements that MUST occur as a result of the flow.
ANY failures during the flow MUST revert the entire flow, leaving the
state of the tokens unchanged.
The structure of the stack can be thought of as a simple list of transfers.
All the erc20 tokens are moved first, then the erc721 tokens, then the
erc1155 tokens. Each token type is separated in the stack by a sentinel
value. The sentinel is a constant, <code>RAIN_FLOW_SENTINEL</code>, that is guaranteed
to not collide with any token amounts or addresses. The sentinel is also
guaranteed to not collide with any other sentinels from other contexts, to
the extent that we can guarantee that with raw cryptographic collision
resistance. This sentinel can be thought of as similar to the null terminator
in a c string, it's a value that is guaranteed to not be a valid value for
the type of data it's separating. The main benefit in this context, for
rainlang authors, is that they can always use the same constant value in
all their rainlang code to separate the different token types, rather than
needing to manually calculate the length of the tuples they're wanting to
flow over in each token type (which would be very error prone).
Currently every token transfer type MUST be present in every flow stack,
which is awkward as it means that if you want to flow erc20 tokens, you
MUST also flow erc721 and erc1155 tokens, even if you don't want to. This
is a limitation of the current implementation, and will be fixed in a future
version.
Each individual token transfer is simply a list of values, where the values
are specific to the token type.</li>
<li>erc20 transfers are a list of 4 values:</li>
<li>address of the token contract</li>
<li>address of the token sender</li>
<li>address of the token recipient</li>
<li>amount of tokens to transfer</li>
<li>erc721 transfers are a list of 4 values:</li>
<li>address of the token contract</li>
<li>address of the token sender</li>
<li>address of the token recipient</li>
<li>token id to transfer</li>
<li>erc1155 transfers are a list of 5 values:</li>
<li>address of the token contract</li>
<li>address of the token sender</li>
<li>address of the token recipient</li>
<li>token id to transfer</li>
<li>amount of tokens to transfer
The final stack is processed from the bottom up, so the first token transfer
in the stack is the last one to be processed.
For example, a rainlang expression that transfers 1e18 erc20 token 0xf00baa
from the flow contract to the address 0xdeadbeef, and 1 erc721 token address
0x1234 and id 5678 from the address 0xdeadbeef to the flow contract, would
result in the following rainlang/stack:</li>
</ul>
<pre><code>* sentinel is always the same. */
sentinel: 0xfea74d0c9bf4a3c28f0dd0674db22a3d7f8bf259c56af19f4ac1e735b156974f,
* erc1155 transfers are first, just a sentinel as there's nothing to do */
_: sentinel,
* erc721 transfers are next, with the token id as the last value */
_: 0x1234 0xdeadbeef context&lt;0 1&gt;() 5678,
* erc20 transfers are last, with the amount as the last value */
_: 0xf00baa context&lt;0 1&gt;() 0xdeadbeef 1e18;
</code></pre>
<p>Note that for all token transfers the sender of the tokens MUST be either
the flow contract itself, or the caller of the flow contract. This is to
prevent the flow contract from being able to transfer tokens from arbitrary
addresses without their consent. Even if some address has approved the flow
contract to transfer tokens on their behalf, the flow contract MUST NOT
transfer tokens from that address unless the caller of the flow contract
is that address.
Note that native gas movements are not supported in this version of the
flow contract. This is because the current reference implementation uses
<code>Multicall</code> to batch together multiple calls to the flow contract, and
this involves a loop over a delegate call, which is not safe to do with
native gas movements. This will be fixed in a future version of the interface
where batching is handled by the flow contract itself, rather than relying
on <code>Multicall</code>.</p>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="stacktoflow"><a class="header" href="#stacktoflow">stackToFlow</a></h3>
<p>Given a stack of values, convert it to a flow transfer. MUST NOT modify
state but MAY revert if the stack is malformed. The intended workflow is
that the interpreter contract is called to produce a stack then the stack
is converted to a flow transfer struct, to allow the caller to preview
a flow before actually executing it. By accepting a stack as input, the
caller can preview any possible flow, not just ones that have been
registered with the flow contract, and can preview flows that may not
even be possible to execute due to the state of the tokens, or access
gating that would exclude the caller, etc.</p>
<pre><code class="language-solidity">function stackToFlow(uint256[] memory stack) external pure returns (FlowTransferV1 calldata flowTransfer);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>stack</code></td><td><code>uint256[]</code></td><td>The stack of values to convert to a flow transfer.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>flowTransfer</code></td><td><code>FlowTransferV1</code></td><td>The resulting flow transfer.</td></tr>
</tbody></table>
</div>
<h3 id="flow"><a class="header" href="#flow">flow</a></h3>
<p>Given an evaluable, caller context, and signed contexts, evaluate the
evaluable and return the resulting flow transfer. MUST process the
flow transfer atomically, either all of it succeeds or none of it
succeeds. MUST revert if the evaluable is not registered with the flow
contract. MUST revert if the evaluable reverts. MUST revert if the
evaluable returns a stack that is malformed. MUST revert if the evaluable
returns a stack that contains a token transfer that is not allowed by
the flow contract (e.g. if a token is being moved from an address that
is not the caller or the flow contract).</p>
<pre><code class="language-solidity">function flow(Evaluable calldata evaluable, uint256[] calldata callerContext, SignedContextV1[] calldata signedContexts)
    external
    returns (FlowTransferV1 calldata flowTransfer);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>evaluable</code></td><td><code>Evaluable</code></td><td>The evaluable to evaluate.</td></tr>
<tr><td><code>callerContext</code></td><td><code>uint256[]</code></td><td>The caller context to pass to the evaluable.</td></tr>
<tr><td><code>signedContexts</code></td><td><code>SignedContextV1[]</code></td><td>The signed contexts to pass to the evaluable.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>flowTransfer</code></td><td><code>FlowTransferV1</code></td><td>The resulting flow transfer.</td></tr>
</tbody></table>
</div>
<h2 id="events"><a class="header" href="#events">Events</a></h2>
<h3 id="initialize"><a class="header" href="#initialize">Initialize</a></h3>
<p>MUST be emitted when the flow contract is initialized.</p>
<pre><code class="language-solidity">event Initialize(address sender, EvaluableConfigV2[] config);
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../src/interface/unstable/IFlowERC721V4.sol/interface.IFlowERC721V4.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../../../src/interface/IFlowERC1155V3.sol/struct.FlowERC1155Config.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../src/interface/unstable/IFlowERC721V4.sol/interface.IFlowERC721V4.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../../../src/interface/IFlowERC1155V3.sol/struct.FlowERC1155Config.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../../elasticlunr.min.js"></script>
        <script src="../../../../mark.min.js"></script>
        <script src="../../../../searcher.js"></script>

        <script src="../../../../clipboard.min.js"></script>
        <script src="../../../../highlight.js"></script>
        <script src="../../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../../solidity.min.js"></script>


    </div>
    </body>
</html>
